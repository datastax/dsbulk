#!/bin/sh

# Copyright (C) 2017 DataStax Inc.
#
# This software can be used solely with DataStax Enterprise. Please consult the license at
# http://www.datastax.com/terms/datastax-dse-driver-license-terms

# Look for a usable Java 8 binary in JAVA_HOME, the result of /usr/libexec/java_home, or path.
for J in "$JAVA_HOME"/bin/java "$(/usr/libexec/java_home 2> /dev/null)/bin/java" java ; do
  if [ -x $J ]; then
    VER=$($J -version 2>&1 | head -1 | sed -e 's/[^"]*"//' -e 's/".*//' -e 's/\.[^\.]*$//')
    MAJOR=$(echo $VER | sed -e 's/\..*$//')
    MINOR=$(echo $VER | sed -e 's/^.*\.//')
    if [ $MAJOR -ge 1 -a $MINOR -ge 8 ] ; then
      # This Java is at least 1.8.
      JAVA=$J
      break
    fi
  fi
done

if [ -z "$JAVA" ] ; then
  echo "Unable to find java 8 (or later) executable. Check JAVA_HOME and PATH environment variables." >&2
  exit 1
fi

INSTALL_DIR=`dirname "$0"`/..

# Set CLASSPATH to include all the jars in the lib dir + the conf directory
# (which contains reference.conf).
for i in $INSTALL_DIR/lib/*.jar $INSTALL_DIR/conf; do
  CLASSPATH="$CLASSPATH:$i"
done

export CLASSPATH

# Attempt to find the window width, to make help output look nicer. This
# expression should work on Linux and Mac at least. If the result isn't a number,
# it means we can't parse the stty output, so don't save off COLUMNS.
COLUMNS=$(stty -a | head -1 | awk -F "; " '{print $3}' | sed -e 's/ *columns *[^0-9]*//')
if /bin/expr  "$COLUMNS" + 0 > /dev/null 2>&1 ; then
  export COLUMNS
fi

# Run the tool.
$JAVA $DSBULK_JAVA_OPTS com.datastax.dsbulk.engine.Main "$@"
